#!/usr/bin/env php
<?php
/**
 * stasi shell, invoked from ~/.ssh/authorized_keys
 *
 * Wraper of ssh comunication.
 * This is logging only.
 *
 * At future:
 *	acl
 *	relative repository
 *	manage user, repositories, konfigure by admin-repo, like gitolite
 *	manage wrapered ~/.ssh/authorized_keys
 */



require_once __dir__ . '/../lib/Stasi/Shell/Config.php';
require_once __dir__ . '/../lib/Stasi/Shell/Model.php';
require_once __dir__ . '/../lib/Stasi/Shell/Router.php';
require_once __dir__ . '/../lib/Stasi/Shell/Request.php';
require_once __dir__ . '/../lib/Stasi/Shell/Dispatcher.php';
require_once __dir__ . '/../lib/Stasi/Shell/Logger.php';

//	Responses
require_once __dir__ . '/../lib/Stasi/Shell/Responses/ResponseInterface.php';
require_once __dir__ . '/../lib/Stasi/Shell/Responses/Response.php';
require_once __dir__ . '/../lib/Stasi/Shell/Responses/ExecResponse.php';

//	Commands
require_once __dir__ . '/../lib/Stasi/Shell/Commands/CommandInterface.php';
require_once __dir__ . '/../lib/Stasi/Shell/Commands/CommandAbstract.php';
require_once __dir__ . '/../lib/Stasi/Shell/Commands/OriginalCommand.php';


use Taco\Tools\Stasi\Shell;



try {
	$logger = new Shell\Logger('logs/stasi');

	$router = new Shell\Router();
	$request = $router->createRequest($_SERVER);

	$config = new Shell\Config();

	$model = new Shell\Model();

	$dispatcher = new Shell\Dispatcher($config, $model);
	$dispatcher->setLogger($logger);
	
	$response = $dispatcher->dispatch($request);
	$response->fetch();
}
catch (\Exception $e) {
	echo $e->getMessage() . PHP_EOL;
	exit($e->getCode() > 0 ? $e->getCode() : 254);
}

