#!/usr/bin/env php
<?php
/**
 * stasi shell, invoked from ~/.ssh/authorized_keys
 *
 * Wraper of ssh comunication.
 * This is logging only.
 *
 * At future:
 *	acl
 *	relative repository
 *	manage user, repositories, konfigure by admin-repo, like gitolite
 *	manage wrapered ~/.ssh/authorized_keys
 */



require_once __dir__ . '/../lib/Stasi/Shell/Config.php';
require_once __dir__ . '/../lib/Stasi/Shell/Model.php';
require_once __dir__ . '/../lib/Stasi/Shell/Router.php';
require_once __dir__ . '/../lib/Stasi/Shell/Request.php';
require_once __dir__ . '/../lib/Stasi/Shell/Dispatcher.php';

//	Responses
require_once __dir__ . '/../lib/Stasi/Shell/Responses/ResponseInterface.php';
require_once __dir__ . '/../lib/Stasi/Shell/Responses/Response.php';
require_once __dir__ . '/../lib/Stasi/Shell/Responses/ExecResponse.php';

//	Commands
require_once __dir__ . '/../lib/Stasi/Shell/Commands/CommandInterface.php';
require_once __dir__ . '/../lib/Stasi/Shell/Commands/OriginalCommand.php';


use Taco\Tools\Stasi\Shell;



try {
	$router = new Shell\Router();
	$request = $router->createRequest($_SERVER);

	$config = new Shell\Config();

	$model = new Shell\Model();

	$dispatcher = new Shell\Dispatcher($config, $model);
	$response = $dispatcher->dispatch($request);
	$response->fetch();
}
catch (\Exception $e) {
	echo $e->getMessage();
	exit($e->getCode() > 0 ? $e->getCode() : 254);
}


file_put_contents('logs/ssh-request/' . date('Y-m-d_H-i-s') . '.log', print_r($GLOBALS, true));
/*
if (isset($_SERVER['SSH_ORIGINAL_COMMAND'])) {
    file_put_contents('logs/original_command/' . date('Y-m-d_H-i-s') . '.log', print_r($_SERVER['SSH_ORIGINAL_COMMAND'], true));
//    passthru($_SERVER['SSH_ORIGINAL_COMMAND']);
}
//*/
